---
title: "VIetnam Bombing History - Chapter 2"
author: "Ha Pham"
output: html_document
urlcolor: blue
---

```{r setup, include=FALSE, echo=FALSE}
source("config/config_pj.R")
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
thunder = fread("data/processed/bombing_rolling_thunder.csv")
vnmap = readRDS("data/raw/vnmap.rds")
north_map = readRDS("data/raw/north_map.rds")
aircrafts = fread("data/raw/THOR_Vietnam_Aircraft_Glossary.csv")


replace_missing(thunder)
thunder[, msndate := ymd(msndate)]
thunder[, msnym := ymd(msnym)]
thunder[, delivered_tonnage := weapontypeweight * numweaponsdelivered ]
thunder[, jettisoned_tonnage := weapontypeweight * numweaponsjettisoned]
thunder[, returned_tonnage := weapontypeweight * numweaponsreturned]

```

Rolling Thunder is an interesting operation to investigate, because the bombing strategy changes over time. 

A little bit of background: 

After Geneva conference in 1954, the U.S. replaces France as a political backup for Ngo Dinh Diem in the South Vietnam, as it feared if Vietnam were fall under the influence of communism, all countries around would follow. At first, the U.S. believed that it could grow South Vietnam's government into a self-sustained one. However, by the beginning of 1965, that belief was turned around when they realized that "without further American action, Saigon government could not survive." 

Operation Rolling Thunder was devised as a demonstration of U.S. commitment with Saigon. 

The operation lasted from 02/03/1965 - 02/11/1968. Objectives. 

- Boost Saigon's morale at first, not to directly and severely affect Hanoi. 
- Persuade North Vietnam to stop supporting South Vietnam's communists withouth sending ground force into North Vietnam
- Destroy North Vietnam's transport system, industrial base, air defenses, which in effect will cut off the supporting line from North to South.

What is interesting here is that the U.S. tried to tread on thin ice here. They want to scare North Vietnam off the South, but they did not dare to go for a full-blown air campaign lest China or Soviet would retaliate with their full might. Therefore, their bombing strategy slowly escalated and changed over time, which will reflect to the data.

# Overview

Some numbers first

Delivered tonnage:

```{r}
sum(thunder$delivered_tonnage) %>% comma()
```

Number of aircraft types


```{r}
uniqueN(thunder$aircraft_root)
```



Overview of bombing targets


```{r}

north_center = c(105.5, 20)
# north_map <- ggmap(get_googlemap(center = north_center, scale = 2, zoom = 6, maptype = "roadmap"), extent = "normal")

target_coord <- thunder[mfunc_desc_class == "KINETIC", .(msnyear, mfunc_desc_class, 
                            lon = tgt_lon, 
                            lat = tgt_lat, 
                            milservice)] %>% unique()

force_col = c(
    "USAF" = "dodgerblue4"
    , "USN" = "darkgoldenrod3"
    , "USMC" = "red3"
    , "VNAF" = "royalblue3"
    , "RLAF" = "gray"
    , "RAAF" = "gray"
    , "KAF" = "gray"
    , "USA" = "gray"
)

```


To minimize airspace conflict among air forces, North Vietnam was divided into six target regions called "route packages":

<center> ![](plot/route_packages.gif) </center>

Each region is assigned to one air force or navy, and they are forbidden to intrude each others' regions. The Navy's Carrier Task Force 77 handled operations in RPs 2, 3, 4, and 6B, as these bordered on the Gulf of Tonkin. The Air Force was given RP 1, RP 5, and 6A. We can see this division clearly from the bombing targets:

```{r}
nsample = 5000
edges = round(north_map$data)
    grid_x = seq(edges$lon[1], edges$lon[2], 1)
    grid_y = seq(edges$lat[1], edges$lat[3], 1)
    
target_df <- target_coord %>% 
    filter(
        mfunc_desc_class == "KINETIC"
        , lon >= edges$lon[1],  lon <= edges$lon[2]
        , lat >= edges$lat[1], lat <= edges$lat[3]
        , milservice %in% c("USN", "USAF")
    ) %>% 
    sample_n(nsample)    

label_df = data.table(
    x = c(107.5, 109)
    , y = c(19, 17)
    , label = c("US Navy", "US Air Force")
)

thunder_map = north_map +
    geom_point(data = target_df, aes(x = lon, y = lat, col = milservice), size = 0.1, show.legend = F) +
    geom_vline(xintercept = grid_x, size = 0.1, alpha = 0.7, color = "gray") +
    geom_hline(yintercept = grid_y, size = 0.1, alpha = 0.7, color = "gray") + 
    geom_label(data = label_df[1], aes(x = x, y = y, label = label), col = "white", fill = force_col["USN"]) +
    geom_label(data = label_df[2], aes(x = x, y = y, label = label), col = "white", fill = force_col["USAF"]) +
    scale_color_manual(values = force_col, name = NULL) +
    scale_x_continuous(breaks = grid_x) + 
    scale_y_continuous(breaks = grid_y) + 
    ggtitle("Rolling Thunder Bombing map 1965 - 1968") + 
    labs(x = "", y = "") + 
    theme(
        panel.background = element_blank()
        , axis.ticks = element_blank()
        , axis.line = element_line(size = 0.1, color = "gray")
    ) 
```

```{r, include=TRUE, fig.height=7, fig.width=7, fig.align="center"}

print(thunder_map)

```

Bombing intensity throughout the years

```{r}
month_aggr = thunder[, .(
    total_tonnage = sum(delivered_tonnage)
    , sortie_count = .N
    ), by = .(msnyear, msnmonth = round_date(msndate, "month"))]

ggplot(month_aggr) + 
    geom_line(aes(x = msnmonth, y = total_tonnage))

```


```{r}
ggplot(month_aggr) + 
    geom_line(aes(x = msnmonth, y = sortie_count))

```


We do not have data before Oct 1965, but we can clearly see Hanoi and Hai Phong were bombed less severly because of U.S.' initial hesitation 

```{r, include=TRUE, fig.height=7, fig.width=7, fig.align="center"}
rt65 = plot_bomb_points(north_map, target_coord, 1965, nsample = 2000, plot_title = "Rolling Thunder target map - 1965")

rt65 + 
    annotate("label", x = 108, y = 21, label = "Hanoi & Haiphong\nwere spared", hjust = 0, alpha = 0.8)  + 
    annotate("rect", xmin = 105.5, xmax = 107, ymin = 20.5, ymax = 21.5, alpha = 0.3, size = 15)

```



Density, for better visualization

```{r, include=TRUE, fig.height=7, fig.width=7, fig.align="center"}
plot_bomb_dens_year(north_map, target_coord, 1965, nsample = 2000)
```

# How do bombing target strategy change

```{r}
tgt_dispersion = thunder[, .(
    sd_lat = sd(tgt_lat, na.rm = T)
    , sd_lon = sd(tgt_lon, na.rm = T)
    
    , range_lat = range(tgt_lat, na.rm = T)[2] - range(tgt_lat, na.rm = T)[1]
    , range_lon = range(tgt_lon, na.rm = T)[2] - range(tgt_lon, na.rm = T)[1]
    
    , iqr_lat = IQR(tgt_lat, na.rm = T)
    , iqr_lon = IQR(tgt_lon, na.rm = T)
), by = .(msn_month = round_date(msndate, "month"))]


```

At first latitude's SD is quite large but then drop --> first random by latitude?
at first longitude's SD is small but then increase --> expand target to different regions in 1969?

Rolling Thunder reached the last stage of its operational evolution during 1967 and 1968. The chief purpose of the American air effort in the higher Route Packages of North Vietnam was slowly transformed into that of interdicting the flow of supplies and material and the destruction of those segments of the north's infrastructure that supported its military effort

1966: bomb on higher route packages to scare the north, thus low longitude variation, high latitude (horizontal) variation
1968 onward: bomb lower route packages (panhandle), thus longitude variation increases

```{r}
ggplot(tgt_dispersion[msn_month >= '1966-01-01'], aes(x = msn_month)) + 
    geom_line(aes(y = sd_lat, group = 1), stat = "identity", color = "red") + 
    geom_line(aes(y = sd_lon, group = 1), stat = "identity", color = "blue") 

```


Coordinate ranges (max - min) is lower, which could means more focused bombing.

```{r}
ggplot(tgt_dispersion[msn_month >= '1966-07-01'], aes(x = msn_month)) + 
    geom_line(aes(y = range_lat, group = 1), stat = "identity", color = "red") + 
    geom_line(aes(y = range_lon, group = 1), stat = "identity", color = "blue") 

```

More on this change of bombing strategy later.

# The gradual escalation

Bombing tonnage in Rolling Thunder increases gradually year-by-year and peaked in 1968, which is why it was described as the bloodiest year in this war.

```{r}
tonnage_time = thunder[, .(total_tonnage = sum(delivered_tonnage)), by = .(msnym)]

ggplot(tonnage_time) + 
    geom_line(aes(x = msnym, y = total_tonnage, group = 1)) + 
    scale_x_date(date_breaks = "1 year", date_labels = "%Y")

```


# Aircraft use by Military services

Looking at aircraft application, fighter - bomber, fighter, attack aircrafts are used most and delivered the highest tonnage of weapon.

```{r}
aircraft_app_ttl = thunder[!is.na(aircraft_application), .(
    count = .N
    , mission_count = uniqueN(missionid)
    , total_tonnage = sum(delivered_tonnage)
    ), by = .(aircraft_application)][order(aircraft_application, -count)]

ggplot(aircraft_app_ttl) + 
    geom_bar(aes(x = reorder(aircraft_application, count), y = count), stat = "identity") + 
    coord_flip()
```

For each of these aircraft, BOMB is still the most used weapon. The percentage of air-to-air weapon used by fighter aircrafts is higher than that of bombers.

```{r}
aircraft_wtype_ttl = thunder[!is.na(aircraft_application) & !is.na(weapon_class), .(
    count = .N
    , total_tonnage = sum(delivered_tonnage)
    ), by = .(aircraft_application, weapon_class)][order(aircraft_application, -count)]
aircraft_wtype_ttl[, pct := count / sum(count), by = .(aircraft_application)]

display_ac = c("FIGHTER, BOMBER", "FIGHTER", "ATTACK", "CARRIER, FIGHTER", "TACTICAL, BOMBER", "STRATEGIC, BOMBER")

ggplot(aircraft_wtype_ttl[aircraft_application %in% display_ac]) + 
    geom_bar(aes(x = aircraft_application, y = pct, fill = weapon_class)
             , position = position_stack(), stat = "identity") + 
    coord_flip()

```

What's the use of different aircrafts over time?

ATTACK is use more and more, indicating more precise bombing missions. Pure fighter aircrafts used less or were adapted into fighter - bomber roles because by this time dogfighting (air-to-air combat) were fallen out of favor in the U.S. This is due their belief that missiles were all they needed to shoot down Soviet's heavy bombers. (Official dogfight training only returned by 1969 with the TOPGUN program.) 

```{r}

aircraft_app_time = thunder[!is.na(aircraft_application), .(
    count = .N
    , total_tonnage = sum(delivered_tonnage)
    ), by = .(aircraft_application, msnym)][order(-count)]


ap = ggplot(aircraft_app_time) + 
    geom_line(aes(x = msnym, y = total_tonnage, group = aircraft_application, color = aircraft_application))

ggplotly(ap)

```

Which aircraft were used in each application?

```{r}
aircraft_use_ttl = thunder[!is.na(aircraft_application), .(
    count = .N
    , total_delivered = sum(delivered_tonnage)
    , total_jettisoned = sum(jettisoned_tonnage)
    , total_returned = sum(returned_tonnage)
    
    ), by = .(aircraft_root, aircraft_type, aircraft_application, milservice)][order(aircraft_application, -count)]

top_aircrafts = aircraft_use_ttl[, head(.SD, 2), by = .(aircraft_application, milservice)]

```


```{r}
aircraft_use_time = thunder[aircraft_root %in% top_aircrafts$aircraft_root, .(
    count = .N
    , total_delivered = sum(delivered_tonnage)
    , total_jettisoned = sum(jettisoned_tonnage)
    , total_returned = sum(returned_tonnage)
    , mission_count = uniqueN(missionid)
    ), by = .(aircraft_root, aircraft_application, msnym)]

```

```{r}

pa2 = ggplot(aircraft_use_time) + 
    geom_line(aes(x = msnym, y = mission_count, group = aircraft_root, color = aircraft_root)) +
    facet_wrap(~aircraft_application, scales = "free")

ggplotly(pa2)

```


On 2 January 1967, the Americans sprang a surprise on the MiGs when they launched Operation Bolo

The U.S. Air Force and the US Navy continued to lay down great expectations on the F4 Phantom, assuming that the massive arms, the perfect on-board radar, the highest speed and acceleration properties, coupled with the new tactics would provide "Phantoms" an advantage over the MiGs. But in encounters with lighter VPAF's MiG-21, F-4 began to suffer defeat. From May to December 1966, the U.S lost 47 aircraft in air battles, destroying only 12 enemy's fighters[90]


# Which military services fly the most mission?

U.S. Navy flew the most missions.

```{r}
milservices_count = thunder[, .(count = .N), by = .(milservice)][order(-count)]
```

And mostly they used A-4 Skyhawks

```{r}
service_aircraft = thunder[, .(count = .N), by = .(milservice, aircraft_root)]

ggplot(service_aircraft) + 
    geom_bar(aes(x = milservice, y = count, fill = aircraft_root)
             , position = position_stack(), stat = "identity")

```